<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Monitoring - Smart Akuarium</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>

  <body class="monitoring-page">
    <nav class="custom-navbar">
      <div class="left-nav">
        <a href="{{ url_for('index') }}" class="back-link">← Kembali</a>
        <span>Smart Akuarium</span>
      </div>
      <div>
        Hi, {{ username }} &nbsp;|&nbsp;
        <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
      </div>
    </nav>

    <div id="notification" class="notification" style="display: none"></div>

    <main class="container mt-4">
      <h1>Monitoring Data Real-Time</h1>
      <div id="data-box" class="data-box mt-4">
        <h4>Data TDS</h4>
        <p>
          <strong>TDS:</strong>
          <span id="value">--</span> ppm
        </p>
        <p><strong>Waktu:</strong> <span id="timestamp">--</span></p>
      </div>
    </main>

    <footer class="mt-5 text-center">
      &copy; 2025 Febriansyah — Universitas Muhammdiyah Prof. Dr. Hamka
    </footer>

    <script>
      function showNotification(message) {
        const notification = document.getElementById("notification");
        notification.innerText = message;
        notification.style.display = "block";
      }

      function hideNotification() {
        const notification = document.getElementById("notification");
        notification.style.display = "none";
      }

      function checkAnomaly(data) {
        let messages = [];
        if (data.tds < 200 || data.tds > 500) {
          messages.push(`⚠️ TDS ${data.tds} ppm tidak sesuai standar!`);
        }

        if (messages.length > 0) {
          showNotification(messages.join(" | "));
        } else {
          hideNotification();
        }
      }

      function updateDataBox() {
        fetch("/data")
          .then((res) => res.json())
          .then((data) => {
            if (data.tds !== undefined) {
              document.getElementById("value").textContent =
                data.tds.toFixed(2);
              document.getElementById("timestamp").textContent =
                data.timestamp || "--";

              checkAnomaly(data);
            } else {
              document.getElementById("value").textContent = "--";
              document.getElementById("timestamp").textContent = "--";
              hideNotification();
            }
          })
          .catch((error) => {
            console.error("Error fetching data:", error);
            document.getElementById("value").textContent = "--";
            document.getElementById("timestamp").textContent = "--";
            hideNotification();
          });
      }

      updateDataBox();
      setInterval(updateDataBox, 4000);
    </script>
  </body>
</html>
