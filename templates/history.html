<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>History - Smart Akuarium</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body class="history-page">
    <nav>
      <div class="left-nav">
        <a href="{{ url_for('index') }}" class="back-link">‚Üê Kembali</a>
        <span>Smart Aquarium</span>
      </div>
      <div>
        Hi, {{ username }} &nbsp;|&nbsp;
        <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
      </div>
    </nav>

    <main>
      <h1>History Monitoring</h1>

      <form
        method="POST"
        action="{{ url_for('clear_history') }}"
        class="delete-form"
      >
        <button
          type="submit"
          class="delete-btn"
          onclick="return confirm('Apakah kamu yakin ingin menghapus semua riwayat?')"
        >
          üóëÔ∏è Hapus Semua Riwayat
        </button>
      </form>
      <div class="table-wrapper">
        <table id="history-table" aria-label="History Monitoring Table">
          <thead>
            <tr>
              <th onclick="sortTable(0)">Timestamp ‚¨ç</th>
              <th onclick="sortTable(1)">TDS (ppm) ‚¨ç</th>
            </tr>
          </thead>
          <tbody id="history-body">
            <tr>
              <td colspan="4">Loading data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <footer>
      &copy; 2025 Febriansyah ‚Äî Universitas Muhammdiyah Prof. Dr. Hamka
    </footer>

    <script>
      async function fetchHistory() {
        try {
          const res = await fetch("/history_data");
          if (!res.ok) throw new Error("Gagal mengambil data history.");
          const data = await res.json();
          return data;
        } catch (error) {
          console.error("Fetch error:", error);
          return null;
        }
      }

      function renderTable(data) {
        const tbody = document.getElementById("history-body");
        tbody.innerHTML = "";

        if (!data || !data.length) {
          tbody.innerHTML =
            '<tr><td colspan="4">Tidak ada data atau gagal mengambil data.</td></tr>';
          return;
        }

        data.forEach((item) => {
          const tr = document.createElement("tr");
          const tds = isNaN(item.tds) ? "-" : item.tds;
          const time = item.timestamp || "-";

          tr.innerHTML = `
            <td>${time}</td>
            <td>${tds}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      let asc = [true, true, true, true];
      function sortTable(colIndex) {
        fetchHistory().then((data) => {
          if (!data) return;
          data.sort((a, b) => {
            let valA, valB;
            switch (colIndex) {
              case 0:
                valA = new Date(a.timestamp);
                valB = new Date(b.timestamp);
                break;
              case 1:
                valA = a.tds;
                valB = b.tds;
                break;
            }
            return asc[colIndex]
              ? valA > valB
                ? 1
                : -1
              : valA < valB
              ? 1
              : -1;
          });
          asc[colIndex] = !asc[colIndex];
          renderTable(data);
        });
      }

      fetchHistory().then(renderTable);
    </script>
  </body>
</html>
